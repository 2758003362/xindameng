name: Flask XML服务打包（兼容GLIBC 2.31）

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 配置静态Python环境（兼容GLIBC 2.31）
        run: |
          wget https://github.com/astral-sh/python-build-standalone/releases/download/20240224/cpython-3.11.8+20240224-x86_64-unknown-linux-gnu-install_only.tar.gz
          
          if [ ! -f "cpython-3.11.8+20240224-x86_64-unknown-linux-gnu-install_only.tar.gz" ]; then
            echo "错误：Python压缩包下载失败"
            exit 1
          fi
          
          mkdir -p python
          tar -xzf cpython-3.11.8+20240224-x86_64-unknown-linux-gnu-install_only.tar.gz -C python --strip-components=1
          
          if [ ! -f "./python/bin/python" ]; then
            echo "错误：Python解压失败"
            exit 1
          fi
          echo "✅ 静态Python配置完成，版本：$(./python/bin/python --version)"

      - name: 获取低版本libstdc++/libgcc_s（兼容GLIBC）
        run: |
          # 1. 下载Ubuntu 20.04的libstdc++6包
          echo "下载Ubuntu 20.04的libstdc++6包..."
          stdcxx_urls=(
            "http://security.ubuntu.com/ubuntu/pool/main/g/gcc-10/libstdc++6_10.5.0-1ubuntu1~20.04_amd64.deb"
            "https://mirrors.tuna.tsinghua.edu.cn/ubuntu/pool/main/g/gcc-10/libstdc++6_10.5.0-1ubuntu1~20.04_amd64.deb"
            "http://archive.ubuntu.com/ubuntu/pool/main/g/gcc-10/libstdc++6_10.5.0-1ubuntu1~20.04_amd64.deb"
            "http://security.ubuntu.com/ubuntu/pool/main/g/gcc-10/libstdc++6_10-20200411-0ubuntu1_amd64.deb"
          )
          
          stdcxx_download_success=false
          for url in "${stdcxx_urls[@]}"; do
            echo "尝试从 $url 下载libstdc++6..."
            if wget -q "$url" -O libstdc++6.deb; then
              if dpkg-deb -I libstdc++6.deb &> /dev/null; then
                stdcxx_download_success=true
                echo "✅ 下载成功: $(basename $url)"
                break
              else
                echo "下载的文件损坏，尝试下一个源..."
                rm -f libstdc++6.deb
              fi
            else
              echo "下载失败，尝试下一个源..."
            fi
          done
          
          if [ "$stdcxx_download_success" = false ]; then
            echo "错误：所有libstdc++下载源均失败"
            SYSTEM_LIBSTDCPP_PATH=$(ldconfig -p | grep "libstdc++.so.6" | head -n 1 | awk '{print $4}')
            if [ -n "$SYSTEM_LIBSTDCPP_PATH" ]; then
              cp "$SYSTEM_LIBSTDCPP_PATH" ./libstdc++.so.6
              echo "LOW_GLIBC_LIBSTDCPP_PATH=./libstdc++.so.6" >> $GITHUB_ENV
              echo "✅ 使用系统libstdc++.so.6作为备选方案"
            else
              echo "错误：无法找到可用的libstdc++.so.6"
              exit 1
            fi
          else
            mkdir -p libstdc++
            dpkg-deb -x libstdc++6.deb libstdc++
            LOW_GLIBC_LIBSTDCPP_PATH=$(find ./libstdc++ -name "libstdc++.so.6" | head -n 1)
            
            if [ -z "$LOW_GLIBC_LIBSTDCPP_PATH" ] || [ ! -f "$LOW_GLIBC_LIBSTDCPP_PATH" ]; then
              echo "错误：未找到低版本libstdc++.so.6"
              exit 1
            fi
            
            echo "LOW_GLIBC_LIBSTDCPP_PATH=$LOW_GLIBC_LIBSTDCPP_PATH" >> $GITHUB_ENV
            echo "✅ 低版本libstdc++准备完成: $LOW_GLIBC_LIBSTDCPP_PATH"
          fi

          # 2. 下载Ubuntu 20.04的libgcc_s1包（解决GLIBC_2.35依赖）
          echo "下载Ubuntu 20.04的libgcc_s1包..."
          gccs_urls=(
            "http://security.ubuntu.com/ubuntu/pool/main/g/gcc-10/libgcc-s1_10.5.0-1ubuntu1~20.04_amd64.deb"
            "https://mirrors.tuna.tsinghua.edu.cn/ubuntu/pool/main/g/gcc-10/libgcc-s1_10.5.0-1ubuntu1~20.04_amd64.deb"
            "http://archive.ubuntu.com/ubuntu/pool/main/g/gcc-10/libgcc-s1_10.5.0-1ubuntu1~20.04_amd64.deb"
            "http://security.ubuntu.com/ubuntu/pool/main/g/gcc-10/libgcc-s1_10-20200411-0ubuntu1_amd64.deb"
          )
          
          gccs_download_success=false
          for url in "${gccs_urls[@]}"; do
            echo "尝试从 $url 下载libgcc_s1..."
            if wget -q "$url" -O libgcc_s1.deb; then
              if dpkg-deb -I libgcc_s1.deb &> /dev/null; then
                gccs_download_success=true
                echo "✅ 下载成功: $(basename $url)"
                break
              else
                echo "下载的文件损坏，尝试下一个源..."
                rm -f libgcc_s1.deb
              fi
            else
              echo "下载失败，尝试下一个源..."
            fi
          done
          
          if [ "$gccs_download_success" = false ]; then
            echo "警告：所有libgcc_s1下载源均失败，尝试使用系统自带版本"
            SYSTEM_LIBGCC_S_PATH=$(ldconfig -p | grep "libgcc_s.so.1" | head -n 1 | awk '{print $4}')
            if [ -n "$SYSTEM_LIBGCC_S_PATH" ]; then
              cp "$SYSTEM_LIBGCC_S_PATH" ./libgcc_s.so.1
              echo "LOW_GLIBC_LIBGCC_S_PATH=./libgcc_s.so.1" >> $GITHUB_ENV
              echo "✅ 使用系统libgcc_s.so.1作为备选方案"
            else
              echo "错误：无法找到可用的libgcc_s.so.1"
              exit 1
            fi
          else
            mkdir -p libgcc
            dpkg-deb -x libgcc_s1.deb libgcc
            LOW_GLIBC_LIBGCC_S_PATH=$(find ./libgcc -name "libgcc_s.so.1" | head -n 1)
            
            if [ -z "$LOW_GLIBC_LIBGCC_S_PATH" ] || [ ! -f "$LOW_GLIBC_LIBGCC_S_PATH" ]; then
              echo "错误：未找到低版本libgcc_s.so.1"
              exit 1
            fi
            
            echo "LOW_GLIBC_LIBGCC_S_PATH=$LOW_GLIBC_LIBGCC_S_PATH" >> $GITHUB_ENV
            echo "✅ 低版本libgcc_s准备完成: $LOW_GLIBC_LIBGCC_S_PATH"
          fi

      - name: 安装Python依赖
        run: |
          ./python/bin/python -m pip install --upgrade pip
          # 仅安装当前Flask应用所需的依赖
          ./python/bin/python -m pip install flask==2.2.3 werkzeug==2.2.3 pyinstaller==5.13.0
          
          # 验证依赖安装
          echo "已安装的Flask版本：$(./python/bin/python -c 'import flask; print(flask.__version__)')"
          echo "已安装的Werkzeug版本：$(./python/bin/python -c 'import werkzeug; print(werkzeug.__version__)')"
          
          # 显式验证导入
          if ./python/bin/python -c "import flask; import werkzeug" &> /dev/null; then
            echo "✅ 所有依赖安装成功且兼容"
          else
            echo "错误：依赖安装或兼容性检查失败"
            # 输出详细错误信息帮助排查
            ./python/bin/python -c "import flask; import werkzeug"
            exit 1
          fi

      - name: 打包应用
        run: |
          # 替换为你的实际入口文件名（例如app.py）
          MAIN_FILE="app.py"
          
          if [ ! -f "./$MAIN_FILE" ]; then
            echo "错误：未找到入口脚本 $MAIN_FILE"
            exit 1
          fi
          
          LOW_GLIBC_LIBSTDCPP_PATH="${{ env.LOW_GLIBC_LIBSTDCPP_PATH }}"
          LOW_GLIBC_LIBGCC_S_PATH="${{ env.LOW_GLIBC_LIBGCC_S_PATH }}"
          
          # 打包命令
          PYINSTALLER_CMD="./python/bin/pyinstaller --onefile --name flask-xml-service \
            --paths=./python/lib/python3.11/site-packages \
            --hidden-import=flask \
            --hidden-import=flask.app \
            --hidden-import=flask.json \
            --hidden-import=werkzeug \
            --hidden-import=jinja2 \
            --hidden-import=click \
            --hidden-import=itsdangerous \
            --add-binary=\"$LOW_GLIBC_LIBSTDCPP_PATH:.\" \
            --add-binary=\"$LOW_GLIBC_LIBGCC_S_PATH:.\" \
            ./$MAIN_FILE"
          
          echo "执行打包命令: $PYINSTALLER_CMD"
          eval $PYINSTALLER_CMD
          
          if [ ! -f "dist/flask-xml-service" ]; then
            echo "错误：打包失败"
            exit 1
          fi
          
          echo "检查最终产物的GLIBC依赖："
          objdump -T dist/flask-xml-service | grep -E "GLIBC_2.3[3-9]|GLIBC_2.[4-9][0-9]" | sort -V | head -10 || echo "✅ 未发现不兼容的高版本GLIBC依赖"
          
          echo "打包完成，文件信息："
          ls -lh dist/flask-xml-service
          file dist/flask-xml-service

      - name: 保存产物
        uses: actions/upload-artifact@v4
        with:
          name: flask-xml-service
          path: dist/flask-xml-service
          retention-days: 7

  release:
    needs: build-linux
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: 下载产物
        uses: actions/download-artifact@v4
        with:
          name: flask-xml-service

      - name: 创建Release
        uses: softprops/action-gh-release@v2
        with:
          files: flask-xml-service
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}